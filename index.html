<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>인연 확률 계산기</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        /* Custom CSS for a nice gradient button effect */
        .calculate-button {
            background-image: linear-gradient(to right, #f87171 0%, #ef4444 51%, #f87171 100%);
            transition: 0.5s;
            background-size: 200% auto;
            color: white;
            box-shadow: 0 4px 15px 0 rgba(239, 68, 68, 0.75);
        }
        .calculate-button:hover {
            background-position: right center; /* change the direction of the change on hover */
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex items-center justify-center min-h-screen">

    <div id="app" class="w-full max-w-2xl bg-white rounded-xl shadow-2xl p-6 sm:p-10 border border-gray-100">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-red-500 mb-6">💖 인연 확률 계산기 💖</h1>
        <p class="text-center text-gray-600 mb-8">두 분의 이름, 나이, 생일을 입력하여 재미로 보는 인연 점수를 확인해보세요!</p>

        <!-- Input Sections -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">

            <!-- Partner 1 (남자) -->
            <div class="bg-blue-50 p-6 rounded-xl shadow-md border-t-4 border-blue-400">
                <h2 class="text-xl font-semibold mb-4 text-blue-700">👤 파트너 1 (남자)</h2>
                <div class="space-y-4">
                    <!-- 이름 -->
                    <div>
                        <label for="name1" class="block text-sm font-medium text-gray-700 mb-1">이름</label>
                        <input type="text" id="name1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="홍길동" required>
                    </div>
                    <!-- 만 나이 -->
                    <div>
                        <label for="age1" class="block text-sm font-medium text-gray-700 mb-1">만 나이</label>
                        <input type="number" id="age1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="30" min="1" required>
                    </div>
                    <!-- 생일 -->
                    <div>
                        <label for="bday1" class="block text-sm font-medium text-gray-700 mb-1">생일 (월/일)</label>
                        <input type="date" id="bday1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" required>
                    </div>
                </div>
            </div>

            <!-- Partner 2 (여자) -->
            <div class="bg-pink-50 p-6 rounded-xl shadow-md border-t-4 border-pink-400">
                <h2 class="text-xl font-semibold mb-4 text-pink-700">👩 파트너 2 (여자)</h2>
                <div class="space-y-4">
                    <!-- 이름 -->
                    <div>
                        <label for="name2" class="block text-sm font-medium text-gray-700 mb-1">이름</label>
                        <input type="text" id="name2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 transition duration-150" placeholder="성춘향" required>
                    </div>
                    <!-- 만 나이 -->
                    <div>
                        <label for="age2" class="block text-sm font-medium text-gray-700 mb-1">만 나이</label>
                        <input type="number" id="age2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 transition duration-150" placeholder="28" min="1" required>
                    </div>
                    <!-- 생일 -->
                    <div>
                        <label for="bday2" class="block text-sm font-medium text-gray-700 mb-1">생일 (월/일)</label>
                        <input type="date" id="bday2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 transition duration-150" required>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calculate Button -->
        <button id="calculateBtn" class="calculate-button w-full text-lg font-bold py-4 rounded-full mt-4 hover:scale-[1.01] transition duration-300">
            ✨ 인연 확률 계산하기 ✨
        </button>

        <!-- Result Section -->
        <div id="result" class="mt-8 pt-6 border-t border-gray-200 hidden">
            <h3 class="text-2xl font-bold text-center mb-4 text-gray-800">측정 결과</h3>
            <div id="probabilityDisplay" class="text-5xl font-extrabold text-center text-red-600 mb-4"></div>
            <p id="messageDisplay" class="text-lg text-center text-gray-700"></p>
            <div id="scoreDetails" class="mt-4 p-4 bg-gray-50 rounded-lg text-sm text-gray-600"></div>
        </div>

        <!-- Custom Modal for Errors (Replaces alert()) -->
        <div id="modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
            <div class="relative p-5 border w-96 shadow-lg rounded-md bg-white">
                <h3 class="text-lg font-bold text-red-500 mb-3">⚠️ 오류</h3>
                <p id="modalMessage" class="text-gray-700 mb-4"></p>
                <button onclick="document.getElementById('modal').classList.add('hidden')" class="w-full py-2 px-4 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition duration-150">확인</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Imports (required for all interactive applications) -->
    <script type="module">
        // Firebase Configuration and Imports (Standard setup boilerplate)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Global variables provided by the Canvas environment MUST be used.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = {};
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
            } catch (e) {
                console.error("Failed to parse firebase config:", e);
            }
        }
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        setLogLevel('Debug'); // Enable Firestore logging

        // Initialize Firebase and Authenticate
        async function initializeFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                console.warn("Firebase config is empty. Skipping initialization.");
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                const userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log("Firebase initialized. User ID:", userId);

            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
            }
        }

        // --- Core Application Logic (Outside of Firebase init) ---

        // Helper function for the custom error modal
        function showModal(message) {
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('modal').classList.remove('hidden');
        }

        // 1. 이름 궁합 점수 계산 (최대 40점)
        function calculateNameScore(name1, name2) {
            let score = 0;
            const cleanName1 = name1.replace(/\s+/g, '').toLowerCase();
            const cleanName2 = name2.replace(/\s+/g, '').toLowerCase();

            // A. 길이 차이 페널티 (최대 20점)
            const lengthDiff = Math.abs(cleanName1.length - cleanName2.length);
            score += Math.max(0, 20 - lengthDiff * 2); // 10자 차이나면 0점, 같으면 20점.

            // B. 공통 글자 점수 (최대 20점) - 한글 자모는 복잡하므로, 단순 글자(음절) 기준으로 계산
            const set1 = new Set(cleanName1.split(''));
            const set2 = new Set(cleanName2.split(''));
            let sharedCount = 0;
            set1.forEach(char => {
                if (set2.has(char)) {
                    sharedCount++;
                }
            });

            const maxLen = Math.max(cleanName1.length, cleanName2.length);
            if (maxLen > 0) {
                 // 최대 20점. 이름이 길수록 sharedCount가 높아야 점수가 높음.
                score += Math.min(20, Math.floor((sharedCount / maxLen) * 20));
            }

            return Math.round(Math.min(40, score));
        }

        // 2. 나이 궁합 점수 계산 (최대 30점)
        function calculateAgeScore(age1, age2) {
            const ageDiff = Math.abs(age1 - age2);
            let score = 0;

            if (ageDiff === 0) {
                score = 30; // 나이가 같으면 최고 점수
            } else if (ageDiff <= 3) {
                score = 25 - (ageDiff * 5); // 1~3살 차이: 20, 15, 10점
            } else if (ageDiff <= 7) {
                score = 10; // 4~7살 차이: 10점
            } else {
                score = 5; // 8살 이상 차이: 5점
            }

            return Math.round(score);
        }

        // 3. 생일 궁합 점수 계산 (최대 30점)
        function calculateBdayScore(bdayStr1, bdayStr2) {
            // bdayStr format: YYYY-MM-DD
            try {
                const date1 = new Date(bdayStr1);
                const date2 = new Date(bdayStr2);

                const month1 = date1.getMonth() + 1; // 1-12
                const day1 = date1.getDate(); // 1-31
                const month2 = date2.getMonth() + 1;
                const day2 = date2.getDate();

                // 숫자를 문자열로 변환하고 모든 자릿수를 더하는 함수 (ex: 12 -> 1+2=3, 29 -> 2+9=11)
                const sumDigits = (num) => String(num).split('').reduce((sum, digit) => sum + parseInt(digit), 0);

                const sum1 = sumDigits(month1) + sumDigits(day1);
                const sum2 = sumDigits(month2) + sumDigits(day2);

                const diff = Math.abs(sum1 - sum2);

                // 점수: 차이가 작을수록 고득점 (최대 차이: 9+9+9+9 = 36)
                // 30점 만점에서 차이 * 1.5 만큼 감점 (최소 0점)
                const score = Math.max(0, 30 - diff * 1.5);

                return Math.round(score);
            } catch (e) {
                console.error("Birthday calculation error:", e);
                return 0;
            }
        }

        // 메인 계산 함수
        function calculateLoveProbability() {
            const name1 = document.getElementById('name1').value.trim();
            const age1 = parseInt(document.getElementById('age1').value, 10);
            const bday1 = document.getElementById('bday1').value;

            const name2 = document.getElementById('name2').value.trim();
            const age2 = parseInt(document.getElementById('age2').value, 10);
            const bday2 = document.getElementById('bday2').value;

            // 유효성 검사
            if (!name1 || !name2 || isNaN(age1) || isNaN(age2) || !bday1 || !bday2) {
                showModal("모든 항목 (이름, 나이, 생일)을 올바르게 입력해주세요.");
                return;
            }

            if (age1 <= 0 || age2 <= 0) {
                showModal("나이는 1살 이상이어야 합니다.");
                return;
            }

            // 1. 점수 계산
            const nameScore = calculateNameScore(name1, name2);
            const ageScore = calculateAgeScore(age1, age2);
            const bdayScore = calculateBdayScore(bday1, bday2);

            const totalScore = nameScore + ageScore + bdayScore; // Max is 40 + 30 + 30 = 100

            // 2. 최종 확률 (100점 만점이므로 그대로 확률 %)
            const probability = Math.min(100, Math.max(0, totalScore));

            // 3. 메시지 생성
            let message = '';
            let emoji = '';
            if (probability >= 85) {
                message = `🎉 와우! ${probability}%! 운명적인 만남입니다! 하늘이 맺어준 인연일지도 몰라요.`;
                emoji = '😍';
            } else if (probability >= 70) {
                message = `😊 ${probability}%! 아주 높은 확률입니다! 서로에게 좋은 영향을 줄 수 있는 완벽한 조합이네요.`;
                emoji = '🥰';
            } else if (probability >= 50) {
                message = `🙂 ${probability}%! 절반 이상의 확률! 노력한다면 충분히 좋은 관계로 발전할 수 있어요.`;
                emoji = '😊';
            } else if (probability >= 30) {
                message = `🤔 ${probability}%! 조금은 부족하지만, 인연은 만들어가는 것이죠! 희망을 가지세요!`;
                emoji = '🙂';
            } else {
                message = `😅 ${probability}%! 낮은 확률이지만, 이 점수는 단순한 재미일 뿐입니다. 진심이 중요해요!`;
                emoji = '😉';
            }

            // 4. 결과 출력
            const probabilityDisplay = document.getElementById('probabilityDisplay');
            const messageDisplay = document.getElementById('messageDisplay');
            const scoreDetails = document.getElementById('scoreDetails');
            const resultSection = document.getElementById('result');

            probabilityDisplay.innerHTML = `${emoji} ${probability}%`;
            messageDisplay.textContent = message;

            scoreDetails.innerHTML = `
                <h4 class="font-semibold text-gray-800 mb-2">세부 점수 (총점 100점)</h4>
                <ul class="list-disc list-inside space-y-1">
                    <li><span class="font-bold text-blue-600">이름 궁합:</span> ${nameScore}점 (최대 40점)</li>
                    <li><span class="font-bold text-red-600">나이 궁합:</span> ${ageScore}점 (최대 30점)</li>
                    <li><span class="font-bold text-green-600">생일 궁합:</span> ${bdayScore}점 (최대 30점)</li>
                </ul>
            `;

            resultSection.classList.remove('hidden');
        }

        // 이벤트 리스너 설정
        document.getElementById('calculateBtn').addEventListener('click', calculateLoveProbability);

        // Firebase 초기화 호출
        initializeFirebase();
    </script>
</body>
</html>
